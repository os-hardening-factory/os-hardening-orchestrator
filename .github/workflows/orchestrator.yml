name: ğŸ­ OS Hardening Orchestrator

on:
  workflow_dispatch:
    inputs:
      vendor:
        description: "Select OS vendor (amazonlinux, ubuntu, rhel, or all)"
        required: true
        default: "all"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      matrix:
        os_type: ${{ fromJson(github.event.inputs.vendor == 'all' && '["amazonlinux","ubuntu","rhel"]' || format('["{0}"]', github.event.inputs.vendor)) }}
    permissions:
      id-token: write
      contents: write

    steps:
      - name: ğŸ§¾ Checkout orchestrator repo
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ap-south-1

      - name: ğŸ”§ Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget curl gpg python3-pip software-properties-common --no-install-recommends
          wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -y
          sudo apt-get install -y packer
          pip3 install boto3 PyGithub

      - name: ğŸ§© Install required Packer plugins
        shell: bash
        timeout-minutes: 15
        run: |
          echo "ğŸ“¦ Installing required Packer plugins..."
          set -e
          packer plugins install github.com/hashicorp/ansible || true
          packer plugins install github.com/hashicorp/docker || true
          echo "âœ… Installed Packer plugins:"
          packer plugins installed
          echo "â³ Sleeping briefly to stabilize environment..."
          sleep 15

      - name: ğŸ—ï¸ Build hardened image for ${{ matrix.os_type }}
        timeout-minutes: 60
        run: |
          echo "ğŸš€ Building hardened image for ${{ matrix.os_type }}..."
          packer init packer/${{ matrix.os_type }}
          packer validate -var-file=packer/variables.pkr.hcl packer/${{ matrix.os_type }}
          packer build -var-file=packer/variables.pkr.hcl \
                       -var "local_tag=${{ matrix.os_type }}-hardened:v1.0.0-cis1.4-$(date +%Y%m%d)-${GITHUB_SHA::7}" \
                       packer/${{ matrix.os_type }}
