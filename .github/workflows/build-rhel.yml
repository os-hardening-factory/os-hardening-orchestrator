name: ðŸ”´ RHEL Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-rhel:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "rhel"
      OS_VERSION: "9"
      CIS_VERSION: "1.5"
      AWS_REGION: "ap-south-1"
      PACKER_VERSION: "1.14.2"

    steps:
      # ---------------------------------------------------------
      # Step 1 - Checkout repo
      # ---------------------------------------------------------
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Step 2 - Configure AWS credentials (OIDC)
      # ---------------------------------------------------------
      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------
      # Step 3 - Install dependencies
      # ---------------------------------------------------------
      - name: ðŸ”§ Install base dependencies
        run: |
          set -e
          echo "ðŸ”§ Installing base dependencies..."
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip python3-pip gpg jq lsb-release software-properties-common
          pip3 install boto3 PyGithub
          echo "âœ… Base dependencies installed"

      # ---------------------------------------------------------
      # Step 4 - Install Packer (Binary)
      # ---------------------------------------------------------
      - name: ðŸ“¦ Install Packer binary
        run: |
          echo "ðŸ“¦ Installing Packer ${PACKER_VERSION}..."
          curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version
          echo "âœ… Packer installed successfully"

      # ---------------------------------------------------------
      # Step 5 - Install required Packer plugins (fix for 404)
      # ---------------------------------------------------------
      - name: ðŸ§© Install Packer plugins manually (Docker & Ansible)
        run: |
          echo "ðŸ§© Installing required Packer plugins..."
          set -e
          packer plugins install github.com/hashicorp/docker@v1.1.2
          packer plugins install github.com/hashicorp/ansible@v1.1.4
          echo "âœ… Plugins installed successfully"
          packer plugins installed

      # ---------------------------------------------------------
      # Step 6 - Verify Docker availability
      # ---------------------------------------------------------
      - name: ðŸ‹ Verify Docker environment
        run: |
          echo "ðŸ‹ Checking Docker availability..."
          docker --version || (echo "âŒ Docker not found" && exit 1)
          docker info || (echo "âŒ Docker daemon unavailable" && exit 1)
          echo "âœ… Docker is ready"

      # ---------------------------------------------------------
      # Step 7 - Initialize and validate Packer
      # ---------------------------------------------------------
      - name: ðŸ§© Initialize and validate Packer
        run: |
          echo "ðŸ§© Initializing and validating Packer..."
          packer init packer/rhel
          packer validate packer/rhel
          echo "âœ… Packer validation successful"

      # ---------------------------------------------------------
      # Step 8 - Build hardened RHEL image
      # ---------------------------------------------------------
      - name: ðŸ—ï¸ Build hardened RHEL image
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"

          echo "ðŸš€ Building hardened image: ${TAG}"
          packer build \
            -var "image_name=${TAG}" \
            -var "base_image=registry.access.redhat.com/ubi9/ubi:latest" \
            packer/rhel

          echo "âœ… Build completed: ${TAG}:latest"

      # ---------------------------------------------------------
      # Step 9 - Trivy Security Scan
      # ---------------------------------------------------------
      - name: ðŸ” Scan image with Trivy
        run: |
          echo "ðŸ” Installing Trivy scanner..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /tmp
          sudo mv /tmp/trivy /usr/local/bin/trivy

          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"
          mkdir -p reports
          echo "ðŸ” Scanning image: ${TAG}:latest"
          trivy image "${TAG}:latest" --format json -o reports/trivy-${TAG}.json || true
          echo "âœ… Trivy scan complete"

      # ---------------------------------------------------------
      # Step 10 - Upload reports as artifacts
      # ---------------------------------------------------------
      - name: ðŸ“Š Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-rhel-scan
          path: reports/
          retention-days: 30

      # ---------------------------------------------------------
      # Step 11 - Upload compliance report to S3
      # ---------------------------------------------------------
      - name: â˜ï¸ Upload compliance report to S3
        if: success()
        run: |
          echo "â˜ï¸ Uploading compliance report..."
          python3 tools/upload_to_s3_and_trigger_glue.py
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------
      # Step 12 - Update changelog
      # ---------------------------------------------------------
      - name: ðŸª¶ Update vendor changelog
        if: success()
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          echo "ðŸª¶ Updating changelog for ${TAG}..."
          python3 tools/dispatch_to_vendor_repos.py \
            --vendor "${{ env.OS_NAME }}" \
            --cis_profile "cis${{ env.CIS_VERSION }}" \
            --version "v1.0.0" \
            --build_date "${TIMESTAMP}" \
            --summary "CIS ${{ env.CIS_VERSION }} compliance and CVE remediations"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      # ---------------------------------------------------------
      # Step 13 - Build Summary
      # ---------------------------------------------------------
      - name: ðŸ“ Build Summary
        if: always()
        run: |
          echo "## âœ… RHEL Hardened Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: rhel-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CIS Profile**: ${CIS_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check attached artifacts for Trivy security reports." >> $GITHUB_STEP_SUMMARY
