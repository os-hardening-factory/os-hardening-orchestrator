name: ğŸ¦º RHEL Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-rhel:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "rhel"
      OS_VERSION: "9"
      CIS_VERSION: "1.5"
      AWS_REGION: "ap-south-1"
      PACKER_VERSION: "1.14.2"

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”§ Install minimal deps
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip python3-pip jq
          pip3 install --upgrade pip
          pip3 install boto3 PyGithub

      - name: ğŸ“¦ Install Packer via binary (no APT)
        run: |
          echo "ğŸ“¦ Installing HashiCorp Packer v${PACKER_VERSION} (binary)..."
          curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version
          echo "âœ… Packer installed successfully without APT."

      - name: ğŸ§¹ Clean any old plugin cache
        run: |
          rm -rf ~/.config/packer/plugins || true
          mkdir -p ~/.config/packer/plugins/github.com/hashicorp/docker
          mkdir -p ~/.config/packer/plugins/github.com/hashicorp/ansible

      - name: ğŸ§© Install Packer plugins offline (exact versions)
        run: |
          set -e
          D_DIR="$HOME/.config/packer/plugins/github.com/hashicorp/docker"
          A_DIR="$HOME/.config/packer/plugins/github.com/hashicorp/ansible"

          mkdir -p "$D_DIR" "$A_DIR"

          echo "ğŸ“¦ Installing docker plugin v1.1.2..."
          curl -fsSL -o /tmp/pp-docker.zip https://releases.hashicorp.com/packer-plugin-docker/1.1.2/packer-plugin-docker_1.1.2_linux_amd64.zip
          unzip -o /tmp/pp-docker.zip -d /tmp/
          # Detect actual unpacked file dynamically
          DOCKER_BIN=$(find /tmp -maxdepth 1 -type f -name "packer-plugin-docker*" | head -n1)
          mv "$DOCKER_BIN" "$D_DIR/packer-plugin-docker_v1.1.2_x5.0_linux_amd64"
          chmod +x "$D_DIR/packer-plugin-docker_v1.1.2_x5.0_linux_amd64"

          echo "ğŸ“¦ Installing ansible plugin v1.1.4..."
          curl -fsSL -o /tmp/pp-ansible.zip https://releases.hashicorp.com/packer-plugin-ansible/1.1.4/packer-plugin-ansible_1.1.4_linux_amd64.zip
          unzip -o /tmp/pp-ansible.zip -d /tmp/
          ANSIBLE_BIN=$(find /tmp -maxdepth 1 -type f -name "packer-plugin-ansible*" | head -n1)
          mv "$ANSIBLE_BIN" "$A_DIR/packer-plugin-ansible_v1.1.4_x5.0_linux_amd64"
          chmod +x "$A_DIR/packer-plugin-ansible_v1.1.4_x5.0_linux_amd64"

          echo "âœ… Plugins placed successfully:"
          ls -lh "$D_DIR" "$A_DIR"


      - name: ğŸ§© Initialize and validate RHEL Packer template
        run: |
          echo "ğŸ§© Initializing and validating RHEL Packer template..."

          echo "ğŸ” [DEBUG] Current working directory: $(pwd)"
          echo "ğŸ“‚ [DEBUG] Listing packer/rhel structure:"
          ls -R packer/rhel || echo "âš ï¸ packer/rhel directory not found!"

          echo "ğŸ“‚ [DEBUG] Checking ansible paths:"
          if [ ! -f "packer/rhel/ansible/playbook.yml" ]; then
            echo "âŒ Missing file: packer/rhel/ansible/playbook.yml"
            exit 1
          fi
          if [ ! -d "packer/rhel/ansible/roles" ]; then
            echo "âŒ Missing directory: packer/rhel/ansible/roles/"
            exit 1
          fi
          echo "âœ… All required Ansible files exist!"

          echo "ğŸ§© Running Packer init..."
          packer init packer/rhel

          echo "ğŸ§© Running Packer validate..."
          packer validate -var "image_name=rhel-9-cis1.5-hardening-$(date +%Y%m%d)" packer/rhel


      - name: ğŸ—ï¸ Build hardened RHEL image
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"
          echo "ğŸš€ Building hardened image: ${TAG}"
          packer build \
            -var "image_name=${TAG}" \
            -var "base_image=redhat/ubi9:latest" \
            packer/rhel
          echo "âœ… RHEL image build complete: ${TAG}:latest"

      - name: ğŸ” Install Trivy & Scan
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"
          mkdir -p reports
          trivy image "${TAG}:latest" --format json -o reports/trivy-${TAG}.json --severity HIGH,CRITICAL || true

      - name: ğŸ“Š Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: rhel-security-reports
          path: reports/
          retention-days: 30
