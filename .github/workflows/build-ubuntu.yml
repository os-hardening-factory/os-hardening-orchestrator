name: ğŸ§ Ubuntu Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "ubuntu"
      OS_VERSION: "22.04"
      CIS_VERSION: "1.4"
      AWS_REGION: "ap-south-1"
      PACKER_VERSION: "1.14.2"

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ§  Inspect preinstalled Docker/containerd
        run: |
          echo "=== Checking preinstalled container runtimes ==="
          dpkg -l | grep -E "docker|containerd" || echo "No preinstalled container packages found"
          echo "Holding all container runtime packages to prevent conflicts..."
          sudo apt-mark hold docker-ce docker-ce-cli containerd.io containerd || true

      - name: ğŸ”§ Install base dependencies (minimal + safe)
        run: |
          echo "ğŸ”§ Installing required base dependencies..."
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip python3-pip jq gpg lsb-release software-properties-common
          echo "âœ… Base dependencies installed."

      - name: ğŸ“¦ Install Packer via binary (no APT)
        run: |
          echo "ğŸ“¦ Installing HashiCorp Packer v${PACKER_VERSION} (binary)..."
          curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version
          echo "âœ… Packer installed successfully without APT."

      - name: ğŸ§© Install required Packer plugins
        run: |
          echo "ğŸ§© Installing Packer plugins..."
          packer plugins install github.com/hashicorp/docker
          packer plugins install github.com/hashicorp/ansible
          echo "âœ… Plugins installed successfully."

      - name: ğŸ” Install Trivy scanner
        run: |
          echo "ğŸ” Installing Trivy..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /tmp
          sudo mv /tmp/trivy /usr/local/bin/trivy
          trivy --version
          echo "âœ… Trivy installed successfully."

      - name: ğŸ§© Initialize and validate Packer
        run: |
          echo "ğŸ§© Initializing and validating Packer..."
          packer init packer/ubuntu
          packer validate packer/ubuntu
          echo "âœ… Packer templates validated successfully."

      - name: ğŸ—ï¸ Build hardened Ubuntu image
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"
          echo "ğŸš€ Building hardened image: $TAG"
          packer build \
            -var "local_tag=latest" \
            -var "image_name=${TAG}" \
            -var "base_image=ubuntu:22.04" \
            packer/ubuntu
          echo "âœ… Image build complete: ${TAG}:latest"

      - name: ğŸ” Scan image using Trivy
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"
          mkdir -p reports
          trivy image "${TAG}:latest" --format json -o reports/trivy-${TAG}.json --severity HIGH,CRITICAL || true
          echo "âœ… Trivy scan complete."

      - name: ğŸ“Š Upload scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-security-reports
          path: reports/
          retention-days: 30
