name: ðŸ§ Ubuntu Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: ðŸ§¾ Checkout orchestrator repo
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ap-south-1

      - name: ðŸ”§ Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip python3-pip software-properties-common gpg
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com noble main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install -y packer
          sudo apt-get install -y docker.io
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh
          pip3 install boto3 PyGithub

      - name: ðŸ§¾ Verify Ansible Files
        run: |
          echo "Verifying Ansible files for Ubuntu..."
          ls -R packer/ubuntu/ansible || (echo "âŒ Missing Ansible files!" && exit 1)

      - name: ðŸ—ï¸ Build hardened Ubuntu image
        env:
          PACKER_LOG: "1"
        run: |
          echo "ðŸš€ Building Ubuntu CIS 1.4 Hardened Image..."
          packer init packer/ubuntu
          packer validate packer/ubuntu
          packer build \
            -var "os_name=ubuntu" \
            -var "os_version=22.04" \
            -var "cis_version=1.4" \
            -var "timestamp=$(date +%Y%m%d)" \
            packer/ubuntu

      - name: ðŸ” Scan image using Trivy
        run: |
          echo "ðŸ” Scanning hardened image..."
          IMAGE_TAG=$(date +%Y%m%d)
          IMAGE_NAME="ubuntu-22.04-cis1.4-hardening-${IMAGE_TAG}"
          trivy image ${IMAGE_NAME}:latest -f json -o reports/trivy-${IMAGE_NAME}.json || true

      - name: â˜ï¸ Upload compliance report to S3
        run: |
          echo "â˜ï¸ Uploading compliance report..."
          python3 tools/upload_to_s3_and_trigger_glue.py
        env:
          AWS_REGION: ap-south-1

      - name: âœ… Summary
        run: |
          IMAGE_TAG=$(date +%Y%m%d)
          IMAGE_NAME="ubuntu-22.04-cis1.4-hardening-${IMAGE_TAG}"
          echo "### âœ… Ubuntu Hardened Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Image Name: \`${IMAGE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- CIS Version: 1.4" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date)" >> $GITHUB_STEP_SUMMARY
