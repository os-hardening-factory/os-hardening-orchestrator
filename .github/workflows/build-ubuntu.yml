name: üêß Ubuntu Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-ubuntu:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "ubuntu"
      OS_VERSION: "22.04"
      CIS_VERSION: "1.4"
      AWS_REGION: "ap-south-1"
      ACCOUNT_ID: "661539128717"
      PACKER_VERSION: "1.14.2"

    steps:
      # 1Ô∏è‚É£ Checkout Code
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configure AWS credentials (OIDC)
      - name: üîê Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      # 3Ô∏è‚É£ Base dependencies
      - name: üîß Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip jq python3-pip

      # 4Ô∏è‚É£ Install packer
      - name: üì¶ Install Packer
        run: |
          curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version

      # 5Ô∏è‚É£ Initialize and validate packer
      - name: üß© Initialize and validate Packer
        run: |
          packer init packer/ubuntu
          packer validate packer/ubuntu

      # 6Ô∏è‚É£ Build hardened Ubuntu image
      - name: üèóÔ∏è Build hardened Ubuntu image
        run: |
          DATE=$(date +%Y%m%d)
          COMMIT=$(echo "${GITHUB_SHA}" | cut -c1-7)
          BASE_TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}"
          IMAGE_NAME="${BASE_TAG}-hardening-${DATE}"
          echo "Building image: ${IMAGE_NAME}"
          SOURCE_AMI="ami-05a8df10b57fXXXX"
          packer build \
            -var "image_name=${IMAGE_NAME}" \
            -var "base_image=ubuntu:${{ env.OS_VERSION }}" \
            -var "cis_profile=cis${{ env.CIS_VERSION }}" \
            -var "build_date=${DATE}" \
            -var "git_commit=${COMMIT}" \
            -var "source_ami=${SOURCE_AMI}" \
            packer/ubuntu

          echo "DATE=${DATE}" >> $GITHUB_ENV
          echo "COMMIT=${COMMIT}" >> $GITHUB_ENV
          echo "BASE_TAG=${BASE_TAG}" >> $GITHUB_ENV

      # 7Ô∏è‚É£ Run Lynis CIS Compliance Scan (Ubuntu)
      - name: üß™ Run Lynis CIS compliance scan
        run: |
          echo "üß© Running Lynis CIS compliance scan on hardened image..."
          mkdir -p reports
          docker run --rm \
            -v $(pwd)/reports:/report \
            --name lynis-scan \
            ubuntu:${{ env.OS_VERSION }} bash -c "\
              apt-get update -qq && \
              apt-get install -y lynis > /dev/null 2>&1 && \
              lynis audit system --quiet --no-colors | tee /report/lynis-${{ env.OS_NAME }}.txt"
          
          echo "‚úÖ Lynis compliance report generated: reports/lynis-${{ env.OS_NAME }}.txt"
          ls -lh reports/

      # 8Ô∏è‚É£ Run Trivy Vulnerability Scan (Ubuntu)
      - name: üîç Run Trivy CVE scan
        run: |
          echo "üß© Starting Trivy vulnerability scan on hardened image..."
          mkdir -p reports

          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

          # Determine the latest built image tag
          DATE=$(date +%Y%m%d)
          BASE_TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}"
          IMAGE_NAME="${BASE_TAG}-hardening-${DATE}"

          # Run the scan and save JSON output
          trivy image --timeout 10m --severity HIGH,CRITICAL \
            --format json \
            --output reports/trivy-${{ env.OS_NAME }}.json \
            "${IMAGE_NAME}:latest" || true

          echo "‚úÖ Trivy CVE report saved to reports/trivy-${{ env.OS_NAME }}.json"
          ls -lh reports/

      # 9Ô∏è‚É£ Generate Unified Compliance Summary JSON
      - name: üìä Generate compliance summary JSON
        run: |
          echo "üß© Generating unified compliance summary report..."
          mkdir -p reports

          # Extract Lynis hardening index
          CIS_SCORE=$(grep -i "Hardening index" reports/lynis-${{ env.OS_NAME }}.txt | awk '{print $3}' || echo "N/A")

          # Extract Trivy CVE counts
          CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' reports/trivy-${{ env.OS_NAME }}.json)
          HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' reports/trivy-${{ env.OS_NAME }}.json)

          # Build unified JSON
          cat <<EOF > reports/compliance-summary.json
          {
            "os": "${{ env.OS_NAME }}",
            "version": "${{ env.OS_VERSION }}",
            "cis_version": "${{ env.CIS_VERSION }}",
            "cis_score": "$CIS_SCORE",
            "critical_cves": $CRITICAL,
            "high_cves": $HIGH,
            "build_date": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "status": "$(if [ "$CRITICAL" -eq 0 ] && [ "$HIGH" -eq 0 ]; then echo "COMPLIANT"; else echo "NON_COMPLIANT"; fi)"
          }
          EOF

          echo "‚úÖ Compliance summary generated:"
          cat reports/compliance-summary.json

      # üîß Automated Remediation if Checks Fail
      - name: üõ†Ô∏è Run automated remediation (if non-compliant)
        run: |
          pip3 install ansible boto3
          python3 tools/remediate.py



      # 7Ô∏è‚É£ Push hardened image to ECR (immutable)
      - name: üß± Tag and push hardened image to ECR
        run: |
          DATE=$(date +%Y%m%d)
          TIME=$(date +%H%M%S)
          COMMIT=${{ env.COMMIT }}
          BASE_TAG=${{ env.BASE_TAG }}
          FULL_TAG="${BASE_TAG}-${DATE}${TIME}-${COMMIT}"

          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS \
              --password-stdin ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

          docker tag ${BASE_TAG}-hardening-${DATE}:latest \
            ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ env.OS_NAME }}:${FULL_TAG}
          docker push ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ env.OS_NAME }}:${FULL_TAG}

          echo "FULL_TAG=${FULL_TAG}" >> $GITHUB_ENV
          echo "‚úÖ Image pushed with immutable tag: ${FULL_TAG}"

      # 8Ô∏è‚É£ Generate semantic enterprise tag (1.x style)
      - name: üè∑Ô∏è Generate enterprise tag (semantic 1.x versioning)
        id: semver
        run: |
          VENDOR="${{ env.OS_NAME }}"
          VERSION="${{ env.OS_VERSION }}"
          VARIANT="intuit"

          EXISTING_TAGS=$(aws ecr list-images \
            --repository-name hardened-${VENDOR} \
            --region ${{ env.AWS_REGION }} \
            --query "imageIds[?starts_with(imageTag, \`${VENDOR}-${VERSION}-${VARIANT}\`)].imageTag" \
            --output text)

          BASE_VERSION="1.0"
          if [ -z "$EXISTING_TAGS" ]; then
            NEW_VERSION=$BASE_VERSION
          else
            LAST_TAG=$(echo "$EXISTING_TAGS" | tr '\t' '\n' | sort -V | tail -n 1)
            LAST_VERSION=$(echo "$LAST_TAG" | awk -F '-' '{print $NF}')
            MAJOR=$(echo "$LAST_VERSION" | cut -d. -f1)
            MINOR=$(echo "$LAST_VERSION" | cut -d. -f2)
            NEXT_MINOR=$((MINOR + 1))
            NEW_VERSION="${MAJOR}.${NEXT_MINOR}"
          fi

          ENTERPRISE_TAG="${VENDOR}-${VERSION}-${VARIANT}-${NEW_VERSION}"
          echo "ENTERPRISE_TAG=${ENTERPRISE_TAG}" >> $GITHUB_ENV
          echo "üöÄ New enterprise tag: ${ENTERPRISE_TAG}"

      - name: üß± Prepare reports directory
        run: |
          mkdir -p reports
          echo "‚úÖ reports/ folder created at $(pwd)/reports"

      - name: üß™ Create dummy compliance report (debug)
        run: |
          echo '{"os":"ubuntu","status":"upload test","timestamp":"'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"}' > reports/test-report.json
          echo "‚úÖ Created test report file:"
          ls -l reports/



      # 9Ô∏è‚É£ Upload compliance reports to S3 and trigger AWS Glue crawler
      - name: ‚òÅÔ∏è Upload reports to S3 and trigger Glue
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          pip3 install boto3
          python3 tools/upload_to_s3_and_trigger_glue.py \
            --bucket cloud-secure-infra-dev-image-metadata-ap-south-1 \
            --region ${{ env.AWS_REGION }} \
            --os ${{ env.OS_NAME }} \
            --build_date $(date +%Y%m%d)


