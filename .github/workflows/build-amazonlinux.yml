name: ðŸ‹ Amazon Linux Hardened Image Build

on:
  workflow_dispatch:
  workflow_call:

concurrency:
  group: "amazonlinux-${{ github.ref }}"
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write
  security-events: write

env:
  VENDOR: amazonlinux
  PACKER_PLUGIN_DIR: /home/runner/.config/packer/plugins
  TRIVY_CACHE_DIR: /home/runner/.cache/trivy
  TAG: amazonlinux-hardened:${{ github.run_id }}-${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Configure AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ap-south-1

      - name: ðŸ’¾ Cache Packer plugins
        uses: actions/cache@v4
        with:
          path: ${{ env.PACKER_PLUGIN_DIR }}
          key: packer-plugins-${{ runner.os }}-${{ hashFiles('packer/amazonlinux/template.pkr.hcl','packer/amazonlinux/variables.pkr.hcl') }}

      - name: ðŸ’¾ Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: trivy-db-${{ runner.os }}-v1

      - name: ðŸ”§ Install Packer + Trivy + Python deps
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip python3-pip gpg
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com noble main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install -y packer
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          trivy --version
          pip3 install boto3 PyGithub

      - name: ðŸ§© Install required Packer plugins (retry)
        run: |
          set -eux
          for p in github.com/hashicorp/docker github.com/hashicorp/ansible; do
            for i in 1 2 3; do
              if packer plugins install "$p"; then break; fi
              sleep 10
            done
          done

      - name: ðŸ§¾ Verify Ansible files exist
        run: |
          ls -R packer/amazonlinux/ansible

      - name: ðŸ—ï¸ Build hardened Amazon Linux image
        env:
          PACKER_LOG: "1"
        run: |
          packer init packer/amazonlinux
          packer validate packer/amazonlinux

      - name: ðŸ—ƒï¸ Save image
        run: |
          docker image inspect ${TAG}
          docker save ${TAG} -o amazonlinux-hardened-${{ github.run_id }}.tar

      - name: ðŸ” Trivy scan (JSON + SARIF)
        run: |
          mkdir -p reports
          trivy image --cache-dir "${{ env.TRIVY_CACHE_DIR }}" --timeout 10m ${TAG} -f json  -o reports/trivy-amazonlinux.json || true
          trivy image --cache-dir "${{ env.TRIVY_CACHE_DIR }}" --timeout 10m ${TAG} -f sarif -o reports/trivy-amazonlinux.sarif || true

      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: amazonlinux-artifacts-${{ github.run_id }}
          path: |
            reports/trivy-amazonlinux.json
            reports/trivy-amazonlinux.sarif
            amazonlinux-hardened-${{ github.run_id }}.tar

      - name: ðŸ›¡ï¸ Upload SARIF to Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/trivy-amazonlinux.sarif

      - name: â˜ï¸ Upload compliance to S3 + trigger Glue
        env:
          AWS_REGION: ap-south-1
        run: |
          python3 tools/upload_to_s3_and_trigger_glue.py

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker image rm ${TAG} || true
          docker system prune -af || true

      - name: ðŸ§¾ Summary
        if: always()
        run: |
          echo "### Amazon Linux Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Image Tag: \`${TAG}\`" >> $GITHUB_STEP_SUMMARY
