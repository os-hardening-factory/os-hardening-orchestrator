name: ðŸš€ Promote Hardened Image to Prod (with Security Gating + Release Publishing)

on:
  workflow_dispatch:
    inputs:
      vendor:
        description: "OS vendor (e.g., ubuntu, rhel, amazonlinux)"
        required: true
        default: "ubuntu"
      source_tag:
        description: "Existing tag to promote (e.g., ubuntu-22.04-intuit-1)"
        required: true
      target_tag:
        description: "New promotion tag (e.g., ubuntu-22.04-intuit-prod)"
        required: true
        default: "ubuntu-22.04-intuit-prod"
      cis_profile:
        description: "CIS profile version (e.g., cis1.4)"
        required: true
        default: "cis1.4"
      version:
        description: "OS version (e.g., 22.04)"
        required: true
        default: "22.04"

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      AWS_REGION: ap-south-1
      ACCOUNT_ID: "661539128717"

    steps:
      - name: ðŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ§¾ Log input parameters
        run: |
          echo "Vendor        : ${{ github.event.inputs.vendor }}"
          echo "Source tag    : ${{ github.event.inputs.source_tag }}"
          echo "Target tag    : ${{ github.event.inputs.target_tag }}"
          echo "CIS profile   : ${{ github.event.inputs.cis_profile }}"
          echo "Version       : ${{ github.event.inputs.version }}"

      # ---------- Trivy Scan + Security Gating (same as before) ----------
      - name: ðŸ” Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin
          trivy --version

      - name: ðŸ›¡ï¸ Security Gate (Trivy CVE check)
        env:
          VENDOR: ${{ github.event.inputs.vendor }}
          SOURCE_TAG: ${{ github.event.inputs.source_tag }}
          ACCOUNT_ID: ${{ env.ACCOUNT_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}
          BLOCK_SEVERITIES: "CRITICAL,HIGH"
        run: |
          set -euo pipefail
          REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/hardened-${VENDOR}"
          IMG="${REPO}:${SOURCE_TAG}"
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${REPO}
          docker pull "${IMG}"
          mkdir -p reports
          trivy image --timeout 5m --severity ${BLOCK_SEVERITIES} \
            --format json --output "reports/trivy-${VENDOR}-${SOURCE_TAG}.json" "${IMG}" || true
          CRIT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' reports/trivy-${VENDOR}-${SOURCE_TAG}.json)
          HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' reports/trivy-${VENDOR}-${SOURCE_TAG}.json)
          echo "CRITICAL=${CRIT} HIGH=${HIGH}"
          if [ "${CRIT}" -gt 0 ] || [ "${HIGH}" -gt 0 ]; then
            echo "âŒ Blocked due to critical vulnerabilities"; exit 1; fi
          echo "âœ… Passed security gate"

      # ---------- Promotion ----------
      - name: ðŸ§± Retag and push image (Prod)
        if: success()
        run: |
          VENDOR=${{ github.event.inputs.vendor }}
          SRC=${{ github.event.inputs.source_tag }}
          DST=${{ github.event.inputs.target_tag }}
          REPO="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${VENDOR}"
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${REPO}
          docker pull ${REPO}:${SRC}
          docker tag  ${REPO}:${SRC} ${REPO}:${DST}
          docker push ${REPO}:${DST}
          echo "âœ… Promoted ${REPO}:${SRC} â†’ ${REPO}:${DST}"

      - name: ðŸ“Š Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ github.event.inputs.vendor }}-${{ github.event.inputs.source_tag }}
          path: reports/
          retention-days: 30

      # ---------- New Section: Release Notes & Vendor Repo Update ----------
      - name: ðŸ§¾ Generate release metadata and changelog entry
        id: metadata
        if: success()
        run: |
          DATE=$(date +%Y%m%d)
          COMMIT=$(git rev-parse --short HEAD || echo "manual")
          ECR_IMAGE="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ github.event.inputs.vendor }}:${{ github.event.inputs.target_tag }}"
          echo "ECR_IMAGE=${ECR_IMAGE}" >> $GITHUB_ENV
          echo "DATE=${DATE}" >> $GITHUB_ENV
          SUMMARY="Image promoted to prod after security validation. CRITICAL/HIGH CVEs = 0."
          echo "SUMMARY=${SUMMARY}" >> $GITHUB_ENV
          echo "âœ… Metadata prepared."

      - name: ðŸš€ Dispatch release to vendor repo
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          python3 tools/dispatch_to_vendor_repos.py \
            --vendor "${{ github.event.inputs.vendor }}" \
            --cis_profile "${{ github.event.inputs.cis_profile }}" \
            --version "${{ github.event.inputs.version }}" \
            --build_date "${{ env.DATE }}" \
            --summary "${{ env.SUMMARY }}"
          echo "âœ… Release published to vendor repo"

      - name: ðŸ§¾ Record promotion details
        if: success()
        run: |
          echo "Promotion Summary:"
          echo "  Vendor     : ${{ github.event.inputs.vendor }}"
          echo "  Source Tag : ${{ github.event.inputs.source_tag }}"
          echo "  Target Tag : ${{ github.event.inputs.target_tag }}"
          echo "  ECR Image  : ${{ env.ECR_IMAGE }}"
          echo "  Date       : ${{ env.DATE }}"