name: ðŸš€ Promote Hardened Image to Prod (Security Gating + Signing + Release Publishing)

on:
  workflow_dispatch:
    inputs:
      vendor:
        description: "OS vendor (e.g., ubuntu, rhel, amazonlinux)"
        required: true
        default: "ubuntu"
      source_tag:
        description: "Existing tag to promote (e.g., ubuntu-22.04-intuit-1)"
        required: true
      target_tag:
        description: "New promotion tag (e.g., ubuntu-22.04-intuit-prod)"
        required: true
        default: "ubuntu-22.04-intuit-prod"
      cis_profile:
        description: "CIS profile version (e.g., cis1.4)"
        required: true
        default: "cis1.4"
      version:
        description: "OS version (e.g., 22.04)"
        required: true
        default: "22.04"

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      AWS_REGION: us-east-1
      ACCOUNT_ID: "661539128717"
      KMS_KEY_ARN: "arn:aws:kms:us-east-1:661539128717:key/e353a400-0c9a-42b4-95b4-d955d8f64fc3"

    steps:
      # ---------- AWS + Checkout ----------
      - name: ðŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ§¾ Checkout os-hardening-orchestrator repository
        uses: actions/checkout@v4
        with:
          repository: os-hardening-factory/os-hardening-orchestrator
          fetch-depth: 0

      - name: ðŸ§¾ Log input parameters
        run: |
          echo "Vendor        : ${{ github.event.inputs.vendor }}"
          echo "Source tag    : ${{ github.event.inputs.source_tag }}"
          echo "Target tag    : ${{ github.event.inputs.target_tag }}"
          echo "CIS profile   : ${{ github.event.inputs.cis_profile }}"
          echo "Version       : ${{ github.event.inputs.version }}"

      # ---------- Trivy ----------
      - name: ðŸ” Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin
          trivy --version

      - name: ðŸ›¡ï¸ Security Gate (Trivy CVE check)
        env:
          VENDOR: ${{ github.event.inputs.vendor }}
          SOURCE_TAG: ${{ github.event.inputs.source_tag }}
          ACCOUNT_ID: ${{ env.ACCOUNT_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}
          BLOCK_SEVERITIES: "CRITICAL,HIGH"
        run: |
          set -euo pipefail
          REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/hardened-${VENDOR}"
          IMG="${REPO}:${SOURCE_TAG}"
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${REPO}
          docker pull "${IMG}"
          mkdir -p reports
          trivy image --timeout 5m --severity ${BLOCK_SEVERITIES} \
            --format json --output "reports/trivy-${VENDOR}-${SOURCE_TAG}.json" "${IMG}" || true

          CRIT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' reports/trivy-${VENDOR}-${SOURCE_TAG}.json)
          HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' reports/trivy-${VENDOR}-${SOURCE_TAG}.json)
          echo "CRITICAL=${CRIT} HIGH=${HIGH}"
          if [ "${CRIT}" -gt 0 ] || [ "${HIGH}" -gt 0 ]; then
            echo "âŒ Blocked due to critical vulnerabilities"
            exit 1
          fi
          echo "âœ… Passed security gate"

      # ---------- Promote Image ----------
      - name: ðŸ§± Retag and push image (Prod)
        if: success()
        run: |
          VENDOR=${{ github.event.inputs.vendor }}
          SRC=${{ github.event.inputs.source_tag }}
          DST=${{ github.event.inputs.target_tag }}
          REPO="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${VENDOR}"
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${REPO}
          docker pull ${REPO}:${SRC}
          docker tag  ${REPO}:${SRC} ${REPO}:${DST}
          docker push ${REPO}:${DST}
          echo "âœ… Promoted ${REPO}:${SRC} â†’ ${REPO}:${DST}"

      # ---------- Cosign Signing ----------
      - name: ðŸ”‘ Install cosign (Sigstore)
        if: success()
        run: |
          COSIGN_VERSION=v2.4.1
          curl -sSfL https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64 \
            -o cosign && chmod +x cosign && sudo mv cosign /usr/local/bin/
          cosign version

      - name: âœï¸ Sign image with AWS KMS (cosign)
        if: success()
        env:
          COSIGN_EXPERIMENTAL: "1"
          COSIGN_YES: "true"
        run: |
          VENDOR=${{ github.event.inputs.vendor }}
          DST=${{ github.event.inputs.target_tag }}
          REPO="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${VENDOR}"
          IMAGE="${REPO}:${DST}"
          KMS_URI="awskms://${{ env.KMS_KEY_ARN }}"
          echo "ðŸ” Signing ${IMAGE} using ${KMS_URI}"
          cosign sign --key "${KMS_URI}" "${IMAGE}"

      - name: âœ… Verify signature after signing
        if: success()
        run: |
          VENDOR=${{ github.event.inputs.vendor }}
          DST=${{ github.event.inputs.target_tag }}
          REPO="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${VENDOR}"
          IMAGE="${REPO}:${DST}"
          echo "ðŸ” Verifying signature for ${IMAGE}"
          cosign verify --key "awskms://${{ env.KMS_KEY_ARN }}" "${IMAGE}" > cosign-verify.json
          echo "âœ… Signature verified successfully."

      - name: ðŸ“Š Upload scan + signature artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-and-signing-reports
          path: |
            reports/
            cosign-verify.json
          retention-days: 30

      # ---------- Metadata + GitHub Release ----------
      - name: ðŸ§¾ Generate release metadata
        id: metadata
        if: success()
        run: |
          DATE=$(date +%Y%m%d)
          COMMIT=$(git rev-parse --short HEAD || echo "manual")
          ECR_IMAGE="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ github.event.inputs.vendor }}:${{ github.event.inputs.target_tag }}"
          SUMMARY="Image promoted to prod and signed with AWS KMS. CRITICAL/HIGH CVEs = 0."
          echo "DATE=${DATE}" >> $GITHUB_ENV
          echo "COMMIT=${COMMIT}" >> $GITHUB_ENV
          echo "ECR_IMAGE=${ECR_IMAGE}" >> $GITHUB_ENV
          echo "SUMMARY=${SUMMARY}" >> $GITHUB_ENV

      - name: ðŸ Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install PyGithub

      - name: ðŸš€ Dispatch release to vendor repo
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          echo "ðŸ§  Running release dispatch script..."
          python3 tools/dispatch_to_vendor_repos.py \
            --vendor "${{ github.event.inputs.vendor }}" \
            --cis_profile "${{ github.event.inputs.cis_profile }}" \
            --version "${{ github.event.inputs.version }}" \
            --build_date "${{ env.DATE }}" \
            --summary "${{ env.SUMMARY }}"
          echo "âœ… Release successfully created in vendor repo"

      # ---------- Attach Reports ----------
      - name: ðŸ“Ž Attach verification report to release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          VENDOR: ${{ github.event.inputs.vendor }}
        run: |
          RELEASE_TAG="${{ github.event.inputs.version }}-${{ github.event.inputs.cis_profile }}-${{ env.DATE }}"
          REPO="os-hardening-${VENDOR}"
          gh release upload "${RELEASE_TAG}" cosign-verify.json \
            --repo "os-hardening-factory/${REPO}" --clobber
          gh release upload "${RELEASE_TAG}" reports/trivy-${VENDOR}-${{ github.event.inputs.source_tag }}.json \
            --repo "os-hardening-factory/${REPO}" --clobber
          echo "âœ… Uploaded cosign + trivy reports to release"

      # ---------- Summary ----------
      - name: ðŸ§¾ Final promotion summary
        if: always()
        run: |
          echo "âœ… Hardened Image Promotion Summary" > summary.md
          echo "----------------------------------" >> summary.md
          echo "ðŸ§© Vendor:        ${{ github.event.inputs.vendor }}" >> summary.md
          echo "ðŸ·ï¸  Source Tag:   ${{ github.event.inputs.source_tag }}" >> summary.md
          echo "ðŸš€ Target Tag:    ${{ github.event.inputs.target_tag }}" >> summary.md
          echo "ðŸ”– Release:       ${{ github.event.inputs.version }}-${{ github.event.inputs.cis_profile }}-${{ env.DATE }}" >> summary.md
          echo "ðŸ›¡ï¸  CVE Status:   PASSED (0 CRITICAL / 0 HIGH)" >> summary.md
          echo "ðŸ” Signed with:   ${{ env.KMS_KEY_ARN }}" >> summary.md
          echo "ðŸ“¦ ECR Image:     ${{ env.ECR_IMAGE }}" >> summary.md
          echo "ðŸ’¾ Commit:        ${{ env.COMMIT }}" >> summary.md
          echo "ðŸ“… Date:          $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> summary.md
          cat summary.md

      - name: ðŸ“¤ Upload audit summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-summary-${{ github.event.inputs.vendor }}
          path: summary.md
          retention-days: 30
